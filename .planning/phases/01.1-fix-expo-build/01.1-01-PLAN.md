---
phase: 01.1-fix-expo-build
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/react-native-quick-crypto/nitro.json
  - packages/react-native-quick-crypto/nitrogen/generated/android/QuickCryptoOnLoad.cpp
  - packages/react-native-quick-crypto/nitrogen/generated/android/QuickCryptoOnLoad.hpp
autonomous: true

must_haves:
  truths:
    - "HybridEcdh is registered in QuickCryptoOnLoad.cpp"
    - "Nitrogen codegen includes Ecdh in autolinking"
  artifacts:
    - path: "packages/react-native-quick-crypto/nitro.json"
      provides: "Ecdh autolinking entry"
      contains: '"Ecdh"'
    - path: "packages/react-native-quick-crypto/nitrogen/generated/android/QuickCryptoOnLoad.cpp"
      provides: "HybridEcdh registration"
      contains: "HybridEcdh"
  key_links:
    - from: "nitro.json"
      to: "QuickCryptoOnLoad.cpp"
      via: "Nitrogen codegen"
      pattern: 'registerHybridObjectConstructor.*"Ecdh"'
---

<objective>
Register HybridEcdh in Android native layer via Nitrogen codegen.

Purpose: The ECDH module created in Phase 1 is missing from the Nitrogen autolinking configuration. Without this, Android cannot instantiate HybridEcdh objects and the ECDH feature will not work on Android.

Output: Updated nitro.json with Ecdh entry, regenerated QuickCryptoOnLoad.cpp with HybridEcdh registration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-fix-expo-build/01.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Ecdh to nitro.json autolinking</name>
  <files>packages/react-native-quick-crypto/nitro.json</files>
  <action>
Add the Ecdh entry to the autolinking section of nitro.json:

In the "autolinking" object, add:
```json
"Ecdh": { "cpp": "HybridEcdh" }
```

Place it alphabetically after "EcKeyPair" and before "EdKeyPair".

The entry maps the JavaScript interface name "Ecdh" (from ecdh.nitro.ts) to the C++ implementation class "HybridEcdh" (from cpp/ecdh/HybridEcdh.hpp).
  </action>
  <verify>Read nitro.json and confirm "Ecdh": { "cpp": "HybridEcdh" } is present in autolinking section.</verify>
  <done>"Ecdh" entry exists in nitro.json autolinking section, positioned after "EcKeyPair"</done>
</task>

<task type="auto">
  <name>Task 2: Run Nitrogen codegen to regenerate Android files</name>
  <files>
    packages/react-native-quick-crypto/nitrogen/generated/android/QuickCryptoOnLoad.cpp
    packages/react-native-quick-crypto/nitrogen/generated/android/QuickCryptoOnLoad.hpp
  </files>
  <action>
Run Nitrogen codegen from the package directory:

```bash
cd packages/react-native-quick-crypto
bun run specs
```

This runs `nitro-codegen` which:
1. Reads all *.nitro.ts spec files (including ecdh.nitro.ts)
2. Reads nitro.json for autolinking configuration
3. Regenerates nitrogen/generated/android/QuickCryptoOnLoad.cpp with HybridEcdh registration
4. Regenerates nitrogen/generated/ios/QuickCrypto+autolinking.rb (if needed)

After codegen, verify that QuickCryptoOnLoad.cpp now includes:
- `#include "HybridEcdh.hpp"` in the includes
- `HybridObjectRegistry::registerHybridObjectConstructor("Ecdh", ...)` in the initialize function
  </action>
  <verify>
Run: `grep -E "HybridEcdh|registerHybridObjectConstructor.*Ecdh" packages/react-native-quick-crypto/nitrogen/generated/android/QuickCryptoOnLoad.cpp`

Expected output includes both the include and the registration call.
  </verify>
  <done>QuickCryptoOnLoad.cpp contains #include "HybridEcdh.hpp" and Ecdh registration</done>
</task>

</tasks>

<verification>
1. nitro.json contains "Ecdh" in autolinking section
2. QuickCryptoOnLoad.cpp contains HybridEcdh include
3. QuickCryptoOnLoad.cpp contains Ecdh registration
4. No codegen errors or warnings
</verification>

<success_criteria>
- Ecdh added to nitro.json autolinking
- Nitrogen codegen completes without errors
- QuickCryptoOnLoad.cpp registers HybridEcdh
- Android will now find HybridEcdh when JS calls createHybridObject("Ecdh")
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-fix-expo-build/01.1-01-SUMMARY.md`
</output>

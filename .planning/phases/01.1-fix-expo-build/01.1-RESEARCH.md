# Phase 1.1: Fix Expo Build - Research

**Researched:** 2026-01-18
**Domain:** React Native native module build configuration (iOS CocoaPods, Android CMake/Gradle)
**Confidence:** HIGH (verified via codebase analysis)

## Summary

Phase 1.1 addresses pre-existing build issues that block ECDH verification. Two separate platform-specific issues exist:

1. **iOS Issue:** NitroModules headers not found due to missing header search paths in QuickCrypto's CocoaPods configuration. The `#if __has_include(<NitroModules/...>)` preprocessor check fails because the QuickCrypto pod doesn't include the NitroModules header directory in its search paths.

2. **Android Issue:** The linker error "Undefined reference to RSAKeyPair::getPrivateKey()" was reported in earlier investigation but during this research, the error description mentions "HybridRsaCipher.cpp.o" which suggests a compilation issue with the RSA cipher implementation, not a linker issue with RSAKeyPair specifically.

**Primary recommendation:** Fix iOS first (likely simpler header path fix), then investigate Android with fresh build logs.

## Build Issue Analysis

### Issue 1: iOS - NitroModules Headers Not Found

**Error:** `#error NitroModules cannot be found! Are you sure you installed NitroModules properly?`

**Affected files:**
- `nitrogen/generated/shared/c++/CipherArgs.hpp`
- `nitrogen/generated/shared/c++/KeyObject.hpp`
- All other Nitrogen-generated spec files

**Root Cause Analysis:**

The Nitrogen-generated headers use `#if __has_include(<NitroModules/JSIConverter.hpp>)` syntax which requires framework-style header search paths. Analysis of the build configuration shows:

1. **NitroModules Headers Exist:** Headers are properly installed at:
   - `/example/ios/Pods/Headers/Private/NitroModules/` (57 files including JSIConverter.hpp, JSIHelpers.hpp)
   - `/example/ios/Pods/Headers/Public/NitroModules/` (24 files)

2. **NitroModules Own Config Works:** The NitroModules.xcconfig includes:
   ```
   HEADER_SEARCH_PATHS = ... "${PODS_ROOT}/Headers/Private/NitroModules" ...
   ```

3. **QuickCrypto Config Missing Path:** The QuickCrypto xcconfig does NOT include NitroModules header paths:
   - Missing: `"${PODS_ROOT}/Headers/Private/NitroModules"`
   - Missing: `"${PODS_ROOT}/Headers/Public/NitroModules"`

4. **The `__has_include` Check:** Uses angle brackets `<NitroModules/JSIConverter.hpp>` which requires the search path to include a directory where `NitroModules` is a subdirectory. The current path includes `${PODS_ROOT}/Headers/Public` but NOT `${PODS_ROOT}/Headers/Public/NitroModules`.

**Why this is pre-existing:** The issue exists on the stable v1.0.6 tag, not caused by ECDH changes.

### Issue 2: Android - RSAKeyPair Linker Error

**Error:** `Undefined reference to RSAKeyPair::getPrivateKey()`

**Status:** Needs verification with fresh build

**Preliminary Analysis:**

1. **HybridRsaKeyPair.cpp Exists:** The implementation at `cpp/rsa/HybridRsaKeyPair.cpp` defines `getPrivateKey()` correctly.

2. **CMakeLists.txt Includes File:** The Android CMakeLists.txt includes:
   ```cmake
   ../cpp/rsa/HybridRsaKeyPair.cpp
   ```

3. **Nitrogen Registration:** The QuickCryptoOnLoad.cpp properly registers "RsaKeyPair" with HybridRsaKeyPair.

4. **Possible Cause:** The error message format "RSAKeyPair::getPrivateKey()" suggests a mangled name lookup issue or the TAG name "RsaKeyPair" being confused with the actual C++ class.

5. **Alternative Cause:** The continue-here.md mentions "HybridRsaCipher.cpp.o compilation" failure, which might be a different issue than the RSAKeyPair linker error.

**Recommendation:** Get fresh Android build logs to confirm actual error.

## Standard Stack

### iOS Build Configuration

| Component | Current | Expected |
|-----------|---------|----------|
| CocoaPods | Auto-generated via autolinking | Properly configured |
| Header Search Paths | Missing NitroModules | Include NitroModules paths |
| C++ Standard | C++20 | C++20 (correct) |
| Dependencies | NitroModules pod dependency | Correct |

### Android Build Configuration

| Component | Current | Expected |
|-----------|---------|----------|
| CMake | 3.10.0 | Sufficient |
| NDK | Via rootProject | Correct |
| C++ Standard | C++20 | C++20 (correct) |
| Prefabs | openssl, NitroModules | Correct |

## Architecture Patterns

### iOS Header Resolution Pattern

The `#if __has_include(<Framework/Header.hpp>)` pattern requires:
```
HEADER_SEARCH_PATHS contains /path/to/
/path/to/Framework/Header.hpp exists
```

For NitroModules:
```
HEADER_SEARCH_PATHS should contain: ${PODS_ROOT}/Headers/Private
So that: ${PODS_ROOT}/Headers/Private/NitroModules/JSIConverter.hpp
Resolves via: <NitroModules/JSIConverter.hpp>
```

### Android Linker Pattern

For HybridObject registration:
```cpp
// In OnLoad.cpp:
HybridObjectRegistry::registerHybridObjectConstructor("RsaKeyPair", ...);

// The TAG "RsaKeyPair" matches JS interface name
// The actual C++ class is HybridRsaKeyPair
```

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Header paths | Manual xcconfig edits | Podspec configuration | Autolinking will override manual edits |
| Module deps | Manual linking | CocoaPods/CMake deps | Build system handles transitive deps |

## Common Pitfalls

### Pitfall 1: Editing xcconfig Directly

**What goes wrong:** Manual edits to `.xcconfig` files in Pods/Target Support Files/ are overwritten on next `pod install`
**Why it happens:** CocoaPods regenerates these files from podspec
**How to avoid:** Modify the podspec's `pod_target_xcconfig` or use Podfile `post_install` hook
**Warning signs:** Changes disappear after `pod install`

### Pitfall 2: Stale Pods Cache

**What goes wrong:** Old cached pod artifacts cause inconsistent builds
**Why it happens:** CocoaPods caches downloaded/built pods
**How to avoid:** Clean build with `pod deintegrate && pod install`
**Warning signs:** "Works on my machine" syndrome, inconsistent behavior

### Pitfall 3: Missing Ecdh Registration on Android

**What goes wrong:** New Ecdh module not included in OnLoad.cpp
**Why it happens:** Nitrogen codegen may not have been re-run after adding Ecdh
**How to avoid:** Run `bun run nitrogen` after adding new nitro specs
**Warning signs:** Module works on iOS but crashes on Android

## Fix Approaches

### iOS Fix Approach

**Option A: Modify QuickCrypto.podspec (Recommended)**

Add NitroModules header paths to the podspec's xcconfig:

```ruby
# In QuickCrypto.podspec, modify pod_target_xcconfig:
xcconfig = {
  ...existing config...
  "HEADER_SEARCH_PATHS" => [
    ...existing paths...,
    "\"${PODS_ROOT}/Headers/Private/NitroModules\"",  # Add this
  ].join(' ')
}
```

**Option B: Podfile post_install Hook**

Add header search path via Podfile (affects example app only):

```ruby
post_install do |installer|
  installer.pods_project.targets.each do |target|
    if target.name == 'QuickCrypto'
      target.build_configurations.each do |config|
        current = config.build_settings['HEADER_SEARCH_PATHS'] || '$(inherited)'
        config.build_settings['HEADER_SEARCH_PATHS'] =
          "#{current} \"${PODS_ROOT}/Headers/Private/NitroModules\""
      end
    end
  end
end
```

**Recommendation:** Option A (modify podspec) because it fixes the issue for all consumers, not just the example app.

### Android Fix Approach

**Step 1: Verify Ecdh Registration**

Check if `HybridEcdh` is registered in `QuickCryptoOnLoad.cpp`. Current file shows NO Ecdh registration.

**Step 2: Re-run Nitrogen Codegen**

```bash
cd packages/react-native-quick-crypto
bun run nitrogen
```

This should regenerate `QuickCryptoOnLoad.cpp` to include:
```cpp
#include "HybridEcdh.hpp"
// ...
HybridObjectRegistry::registerHybridObjectConstructor("Ecdh", ...);
```

**Step 3: Clean Build**

```bash
cd example/android
./gradlew clean
cd ..
npx react-native run-android
```

**Step 4: If RSAKeyPair Error Persists**

Check if HybridRsaKeyPair.cpp is being compiled:
- Verify file is in CMakeLists.txt source list (it is)
- Check for compilation errors in HybridRsaKeyPair.cpp
- Verify OpenSSL symbols are available

## Implementation Considerations

### Order of Fixes

1. **Android first** - ECDH code already compiles on Android (per continue-here.md), so it may be simpler
2. **Re-run Nitrogen** - May fix missing Ecdh registration
3. **iOS second** - Header path fix is straightforward once identified

### Verification Steps

After each fix:
1. Clean build: Remove build artifacts
2. Rebuild: Full fresh build
3. Run app: Verify no crash on startup
4. Test ECDH: Run test code to verify functionality

### Risk Assessment

| Fix | Risk | Mitigation |
|-----|------|------------|
| Podspec header path | Low | Well-understood CocoaPods pattern |
| Nitrogen re-run | Low | Codegen is deterministic |
| Clean build | None | Standard practice |

## Open Questions

1. **Android Error Specifics:** Need fresh build logs to confirm actual error message
2. **Ecdh Registration:** Is the missing HybridEcdh registration in OnLoad.cpp causing the Android issue?
3. **Expo vs React Native CLI:** Does the expo-test project have different build configuration than the example app?

## Sources

### Primary (HIGH confidence)
- Codebase analysis of QuickCrypto.podspec, CMakeLists.txt
- Codebase analysis of example/ios/Pods/Target Support Files/QuickCrypto/*.xcconfig
- Codebase analysis of nitrogen/generated/android/QuickCryptoOnLoad.cpp

### Secondary (MEDIUM confidence)
- [Nitro GitHub Issues](https://github.com/mrousavy/nitro/issues/812) - NitroModules not found troubleshooting
- [Fixing NitroModules Missing Error](https://brainxx.org/blog/fixing-nitromodules-missing-error-in) - Header path fixes

### Tertiary (LOW confidence)
- General React Native CocoaPods troubleshooting patterns

## Metadata

**Confidence breakdown:**
- iOS root cause: HIGH - verified via xcconfig comparison
- iOS fix approach: HIGH - standard CocoaPods pattern
- Android root cause: MEDIUM - needs fresh build logs to confirm
- Android fix approach: MEDIUM - based on preliminary analysis

**Research date:** 2026-01-18
**Valid until:** 60 days (build tooling is stable)

---
phase: 01.1-fix-expo-build
plan: 03
type: execute
wave: 2
depends_on:
  - "01.1-01"
  - "01.1-02"
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Expo app builds successfully on at least one platform"
    - "ECDH tests run in emulator/simulator"
    - "ECDH tests pass"
  artifacts: []
  key_links:
    - from: "ECDH TypeScript class"
      to: "HybridEcdh C++"
      via: "Nitro bridge"
      pattern: "createECDH.*generateKeys"
---

<objective>
Verify build fixes and test ECDH functionality in Expo example app.

Purpose: Plans 01.1-01 and 01.1-02 made changes to fix Android and iOS builds. This plan verifies those fixes work by building the example app and running ECDH tests.

Output: Verified working ECDH on at least one platform (Android or iOS).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.1-fix-expo-build/01.1-RESEARCH.md
@.planning/phases/01.1-fix-expo-build/01.1-01-SUMMARY.md
@.planning/phases/01.1-fix-expo-build/01.1-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean rebuild Android</name>
  <files></files>
  <action>
Perform a clean Android build to verify the Nitrogen codegen fix:

```bash
cd example/android
./gradlew clean
cd ..
bunx react-native run-android
```

If build succeeds, the HybridEcdh registration is working.

If build fails:
- Check if error is still "Undefined reference to RSAKeyPair" or related
- Capture full error output for diagnosis
- May need additional CMakeLists.txt modifications

Note: Run Android first as it's typically faster to build and test.
  </action>
  <verify>
Android build completes without linker errors.
App launches on emulator.
Check Metro bundler output for any module loading errors.
  </verify>
  <done>Android example app builds and runs on emulator</done>
</task>

<task type="auto">
  <name>Task 2: Clean rebuild iOS (if Android fails, or in parallel)</name>
  <files></files>
  <action>
Perform a clean iOS build to verify the podspec header fix:

```bash
cd example/ios
rm -rf Pods Podfile.lock build
pod install
cd ..
bunx react-native run-ios
```

If build succeeds, the NitroModules header paths are resolved.

If build fails:
- Check if error is still "#error NitroModules cannot be found"
- If so, verify the xcconfig file contains the new paths:
  cat Pods/Target\ Support\ Files/QuickCrypto/*.xcconfig | grep Headers
- Capture full error output for diagnosis
  </action>
  <verify>
iOS build completes without NitroModules header errors.
App launches on simulator.
Check Metro bundler output for any module loading errors.
  </verify>
  <done>iOS example app builds and runs on simulator</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Build fixes for Android (Nitrogen codegen with Ecdh) and iOS (podspec header paths).
At least one platform should now build and run the example app successfully.
  </what-built>
  <how-to-verify>
1. Confirm the app launches without crash on at least one platform (Android or iOS)

2. Test ECDH functionality - in the app's test UI or React Native debugger:
   ```javascript
   import { createECDH } from 'react-native-quick-crypto';

   // Test 1: Create ECDH instance
   const ecdh = createECDH('secp256k1');
   console.log('ECDH created:', ecdh);

   // Test 2: Generate keys
   const pubKey = ecdh.generateKeys('hex');
   console.log('Public key (hex):', pubKey);
   console.log('Public key length:', pubKey.length); // Should be 130 (65 bytes * 2)

   // Test 3: Get private key
   const privKey = ecdh.getPrivateKey('hex');
   console.log('Private key (hex):', privKey);
   console.log('Private key length:', privKey.length); // Should be 64 (32 bytes * 2)

   // Test 4: Set private key and verify derived public key
   const ecdh2 = createECDH('secp256k1');
   ecdh2.setPrivateKey(privKey, 'hex');
   const derivedPubKey = ecdh2.getPublicKey('hex');
   console.log('Derived matches original:', derivedPubKey === pubKey); // Should be true
   ```

3. Expected results:
   - createECDH('secp256k1') returns an ECDH instance
   - generateKeys('hex') returns 130-character hex string
   - getPrivateKey('hex') returns 64-character hex string
   - setPrivateKey + getPublicKey returns same public key

4. If any test fails, note the error message for diagnosis.
  </how-to-verify>
  <resume-signal>
Type "approved" if:
- At least one platform builds successfully
- ECDH tests pass as described above

Type "partial: [description]" if:
- Build works but ECDH tests have issues
- Only one platform works (note which one)

Type "failed: [error description]" if:
- Neither platform builds
- ECDH module crashes on access
  </resume-signal>
</task>

</tasks>

<verification>
1. At least one platform (Android or iOS) builds successfully
2. Example app runs without crash
3. ECDH module is accessible from JavaScript
4. Basic ECDH operations work (createECDH, generateKeys, get/setPrivateKey)
</verification>

<success_criteria>
- Phase 1.1 goal met: "Expo app builds successfully on at least one platform"
- Phase 1.1 goal met: "ECDH tests run in emulator/simulator and all pass"
- Ready to resume Phase 1 Plan 01-04 verification checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/01.1-fix-expo-build/01.1-03-SUMMARY.md`
</output>

---
phase: 01-core-ecdh
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts
  - packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.hpp
  - packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.cpp
  - packages/react-native-quick-crypto/android/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Native ECDH module can be instantiated from JavaScript"
    - "Build succeeds on Android with new ECDH files"
  artifacts:
    - path: "packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts"
      provides: "Nitro interface for ECDH native bridge"
      exports: ["Ecdh"]
    - path: "packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.hpp"
      provides: "C++ ECDH header with method declarations"
      contains: "class HybridEcdh"
    - path: "packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.cpp"
      provides: "C++ ECDH implementation skeleton"
      min_lines: 50
  key_links:
    - from: "ecdh.nitro.ts"
      to: "HybridEcdh.cpp"
      via: "Nitro code generation"
      pattern: "HybridEcdhSpec"
---

<objective>
Create the native ECDH module infrastructure: Nitro interface definition, C++ implementation skeleton, and build system integration.

Purpose: Establishes the native bridge foundation that all ECDH functionality builds upon.
Output: Compilable ECDH native module with stub implementations, integrated into Android build.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-ecdh/01-RESEARCH.md

# Pattern references
@packages/react-native-quick-crypto/src/specs/edKeyPair.nitro.ts
@packages/react-native-quick-crypto/cpp/ed25519/HybridEdKeyPair.hpp
@packages/react-native-quick-crypto/cpp/ed25519/HybridEdKeyPair.cpp
@packages/react-native-quick-crypto/android/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Nitro interface and C++ implementation</name>
  <files>
    packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts
    packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.hpp
    packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.cpp
  </files>
  <action>
Create the Nitro interface following the edKeyPair.nitro.ts pattern:

```typescript
// ecdh.nitro.ts
import type { HybridObject } from 'react-native-nitro-modules';

export interface Ecdh extends HybridObject<{ ios: 'c++'; android: 'c++' }> {
  setCurve(curve: string): void;
  generateKeys(): void;
  getPublicKeyRaw(format: number): ArrayBuffer;  // 0=compressed (33 bytes), 1=uncompressed (65 bytes)
  getPrivateKeyRaw(): ArrayBuffer;               // 32-byte scalar
  setPrivateKeyRaw(privateKey: ArrayBuffer): void;  // Auto-derives public key
}
```

Create HybridEcdh.hpp following HybridEdKeyPair.hpp pattern:
- Include HybridEcdhSpec.hpp (generated by Nitrogen)
- Private members: `std::string curve`, `EVP_PKEY* pkey = nullptr`
- Destructor: free pkey if not nullptr
- Override all interface methods

Create HybridEcdh.cpp with stub implementations that throw "Not implemented":
- setCurve: Store curve name, validate it's "secp256k1"
- generateKeys: Stub throwing "Not implemented"
- getPublicKeyRaw: Stub throwing "Not implemented"
- getPrivateKeyRaw: Stub throwing "Not implemented"
- setPrivateKeyRaw: Stub throwing "Not implemented"

Include necessary OpenSSL headers: openssl/evp.h, openssl/ec.h, openssl/bn.h, openssl/err.h

Reference 01-RESEARCH.md Pattern 2 and Pattern 3 for interface design.
  </action>
  <verify>
Files exist and have valid C++ syntax:
- `ls packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts`
- `ls packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.hpp`
- `ls packages/react-native-quick-crypto/cpp/ecdh/HybridEcdh.cpp`
  </verify>
  <done>
Three files created: ecdh.nitro.ts with Ecdh interface, HybridEcdh.hpp with class declaration, HybridEcdh.cpp with stub implementations
  </done>
</task>

<task type="auto">
  <name>Task 2: Run Nitrogen codegen and update Android CMakeLists</name>
  <files>
    packages/react-native-quick-crypto/android/CMakeLists.txt
    packages/react-native-quick-crypto/nitrogen/generated/
  </files>
  <action>
1. Run Nitrogen code generation from the package directory:
   `cd packages/react-native-quick-crypto && bun run nitro-codegen`

2. Verify HybridEcdhSpec files were generated:
   - nitrogen/generated/shared/c++/HybridEcdhSpec.hpp
   - nitrogen/generated/shared/c++/HybridEcdhSpec.cpp

3. Update android/CMakeLists.txt:
   - Add `../cpp/ecdh/HybridEcdh.cpp` to the add_library sources (after ../cpp/ec/HybridEcKeyPair.cpp)
   - Add `"../cpp/ecdh"` to include_directories (after ../cpp/ec)

4. Verify build compiles (Android):
   `cd example && bun android` (or at minimum verify CMakeLists syntax is valid)

Note: iOS xcodeproj updates are handled automatically by Xcode's folder references or will be addressed in a separate plan if needed.
  </action>
  <verify>
- `ls packages/react-native-quick-crypto/nitrogen/generated/shared/c++/HybridEcdhSpec.hpp`
- `grep -l "HybridEcdh.cpp" packages/react-native-quick-crypto/android/CMakeLists.txt`
- `grep -l "../cpp/ecdh" packages/react-native-quick-crypto/android/CMakeLists.txt`
  </verify>
  <done>
Nitrogen generated HybridEcdhSpec files, CMakeLists.txt updated with new source file and include directory
  </done>
</task>

</tasks>

<verification>
- [ ] ecdh.nitro.ts exports Ecdh interface with 5 methods
- [ ] HybridEcdh.hpp declares class inheriting from HybridEcdhSpec
- [ ] HybridEcdh.cpp has stub implementations for all methods
- [ ] HybridEcdhSpec.hpp/cpp generated by Nitrogen
- [ ] CMakeLists.txt includes HybridEcdh.cpp source and cpp/ecdh directory
</verification>

<success_criteria>
Native ECDH infrastructure is in place: Nitro interface defined, C++ skeleton compiles, build system updated. Ready for Task 2 to implement the actual cryptographic operations.
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-ecdh/01-01-SUMMARY.md`
</output>

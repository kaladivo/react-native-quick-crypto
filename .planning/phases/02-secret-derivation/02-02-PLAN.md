---
phase: 02-secret-derivation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts
  - packages/react-native-quick-crypto/src/ecdh.ts
  - packages/react-native-quick-crypto/nitrogen/generated/shared/c++/HybridEcdhSpec.hpp
  - packages/react-native-quick-crypto/nitrogen/generated/shared/c++/HybridEcdhSpec.cpp
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Nitro interface includes computeSecretRaw method signature"
    - "TypeScript ECDH.computeSecret accepts Buffer, ArrayBuffer, Uint8Array, or string"
    - "computeSecret returns Buffer by default or encoded string with outputEncoding"
    - "computeSecret throws error with code ERR_CRYPTO_ECDH_INVALID_PUBLIC_KEY for invalid keys"
  artifacts:
    - path: "packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts"
      provides: "computeSecretRaw in Ecdh interface"
      contains: "computeSecretRaw"
    - path: "packages/react-native-quick-crypto/src/ecdh.ts"
      provides: "computeSecret method with encoding support"
      contains: "computeSecret"
    - path: "packages/react-native-quick-crypto/nitrogen/generated/shared/c++/HybridEcdhSpec.hpp"
      provides: "Generated C++ spec with computeSecretRaw"
      contains: "computeSecretRaw"
  key_links:
    - from: "src/ecdh.ts"
      to: "native.computeSecretRaw"
      via: "NitroModules call"
      pattern: "this\\.native\\.computeSecretRaw"
    - from: "src/specs/ecdh.nitro.ts"
      to: "HybridEcdhSpec.hpp"
      via: "Nitrogen codegen"
      pattern: "computeSecretRaw.*ArrayBuffer"
---

<objective>
Add TypeScript integration for computeSecret with Nitrogen binding generation.

Purpose: Expose computeSecret to JavaScript with proper encoding support and error handling, matching Node.js crypto.ECDH API.

Output: Complete TypeScript ECDH.computeSecret() method with Nitro binding to C++ implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-secret-derivation/02-RESEARCH.md

# Depends on Plan 01
@.planning/phases/02-secret-derivation/02-01-SUMMARY.md

# Existing implementation
@packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts
@packages/react-native-quick-crypto/src/ecdh.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add computeSecretRaw to Nitro interface and run codegen</name>
  <files>packages/react-native-quick-crypto/src/specs/ecdh.nitro.ts</files>
  <action>
Add computeSecretRaw method to the Ecdh interface:

```typescript
export interface Ecdh extends HybridObject<{ ios: 'c++'; android: 'c++' }> {
  setCurve(curve: string): void;
  generateKeys(): void;
  getPublicKeyRaw(format: number): ArrayBuffer;
  getPrivateKeyRaw(): ArrayBuffer;
  setPrivateKeyRaw(privateKey: ArrayBuffer): void;
  computeSecretRaw(otherPublicKey: ArrayBuffer): ArrayBuffer;  // NEW
}
```

After updating the interface, run Nitrogen codegen:
```bash
cd packages/react-native-quick-crypto && bun run nitrogen
```

This regenerates:
- nitrogen/generated/shared/c++/HybridEcdhSpec.hpp
- nitrogen/generated/shared/c++/HybridEcdhSpec.cpp
  </action>
  <verify>
Run `bun run nitrogen` completes without error.
Check HybridEcdhSpec.hpp contains computeSecretRaw declaration.
  </verify>
  <done>Nitro interface updated and codegen successful</done>
</task>

<task type="auto">
  <name>Task 2: Implement computeSecret in TypeScript ECDH class</name>
  <files>packages/react-native-quick-crypto/src/ecdh.ts</files>
  <action>
Add computeSecret method to the ECDH class with proper encoding support and error handling:

```typescript
computeSecret(
  otherPublicKey: Buffer | ArrayBuffer | Uint8Array | string,
  inputEncoding?: ECDHEncoding,
  outputEncoding?: ECDHEncoding
): Buffer | string {
  try {
    const keyBuffer = this.decodeInput(otherPublicKey, inputEncoding);
    const secretRaw = this.native.computeSecretRaw(keyBuffer);
    return this.encodeOutput(secretRaw, outputEncoding);
  } catch (e) {
    const msg = e instanceof Error ? e.message : String(e);
    if (msg.includes('ERR_CRYPTO_ECDH_INVALID_PUBLIC_KEY')) {
      const err = new Error('Invalid EC public key');
      (err as NodeJS.ErrnoException).code = 'ERR_CRYPTO_ECDH_INVALID_PUBLIC_KEY';
      throw err;
    }
    throw e;
  }
}
```

Add the method after setPrivateKey (around line 40).

This implementation:
1. Decodes input using existing decodeInput helper
2. Calls native computeSecretRaw
3. Encodes output using existing encodeOutput helper
4. Catches native errors and re-throws with Node.js-compatible error code
  </action>
  <verify>TypeScript compiles: `cd packages/react-native-quick-crypto && bun run typecheck`</verify>
  <done>computeSecret method implemented with encoding support and error handling</done>
</task>

<task type="auto">
  <name>Task 3: Build TypeScript and verify package</name>
  <files>packages/react-native-quick-crypto/lib/*</files>
  <action>
Build the TypeScript to verify the changes compile correctly:

```bash
cd packages/react-native-quick-crypto && bun run build
```

This generates:
- lib/module/ecdh.js (ESM)
- lib/commonjs/ecdh.js (CommonJS)
- lib/typescript/ecdh.d.ts (type declarations)

Verify the build output includes computeSecret in the generated files.
  </action>
  <verify>Build completes without errors. `grep -l computeSecret packages/react-native-quick-crypto/lib/typescript/ecdh.d.ts` returns the file.</verify>
  <done>TypeScript builds successfully with computeSecret exported</done>
</task>

</tasks>

<verification>
1. ecdh.nitro.ts includes computeSecretRaw method
2. Nitrogen codegen ran successfully (HybridEcdhSpec files updated)
3. ECDH class has computeSecret method
4. computeSecret handles input/output encoding via existing helpers
5. Error code ERR_CRYPTO_ECDH_INVALID_PUBLIC_KEY properly thrown
6. TypeScript compiles without errors
7. Package builds successfully
</verification>

<success_criteria>
1. Nitro interface updated with computeSecretRaw
2. Nitrogen codegen successful
3. TypeScript ECDH.computeSecret() method working
4. Encoding support (hex, base64, base64url, latin1, binary)
5. Node.js-compatible error handling with proper error codes
6. Package builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-secret-derivation/02-02-SUMMARY.md`
</output>
